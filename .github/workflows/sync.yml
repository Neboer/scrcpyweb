name: åŒæ­¥ä¸Šæ¸¸ä»“åº“

permissions:
  contents: write

on:
  schedule:
    - cron: "0 2 * * 1" # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    name: åŒæ­¥ä¸Šæ¸¸æœ€æ–°æäº¤
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ·»åŠ å¹¶èŽ·å–ä¸Šæ¸¸ä»“åº“
        id: fetch_upstream
        run: |
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“
          git remote add upstream https://github.com/NetrisTV/ws-scrcpy.git || true
          
          # å°è¯•èŽ·å–ä¸Šæ¸¸ä»“åº“
          if git fetch upstream; then
            echo "upstream_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… æˆåŠŸèŽ·å–ä¸Šæ¸¸ä»“åº“" >> $GITHUB_STEP_SUMMARY
          else
            echo "upstream_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ æ— æ³•è®¿é—®ä¸Šæ¸¸ä»“åº“" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: åˆå¹¶ä¸Šæ¸¸æ›´æ”¹
        if: steps.fetch_upstream.outputs.upstream_exists == 'true'
        id: merge
        run: |
          # èŽ·å–å½“å‰åˆ†æ”¯
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          # å°è¯•åˆå¹¶ä¸Šæ¸¸ master åˆ†æ”¯
          if git merge upstream/master --no-edit -m "Merge upstream changes from NetrisTV/ws-scrcpy"; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "âœ… æˆåŠŸåˆå¹¶ä¸Šæ¸¸æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
            
            # æ˜¾ç¤ºåˆå¹¶çš„æäº¤æ•°
            COMMITS=$(git rev-list --count HEAD@{1}..HEAD)
            echo "ðŸ“Š åˆå¹¶äº† $COMMITS ä¸ªæ–°æäº¤" >> $GITHUB_STEP_SUMMARY
          else
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            echo "âŒ åˆå¹¶å¤±è´¥ï¼šå­˜åœ¨å†²çª" >> $GITHUB_STEP_SUMMARY
            
            # æ˜¾ç¤ºå†²çªæ–‡ä»¶
            echo "### å†²çªæ–‡ä»¶åˆ—è¡¨ï¼š" >> $GITHUB_STEP_SUMMARY
            git diff --name-only --diff-filter=U >> $GITHUB_STEP_SUMMARY
            
            # ä¸­æ­¢åˆå¹¶
            git merge --abort
            exit 1
          fi

      - name: æŽ¨é€æ›´æ”¹
        if: steps.merge.outputs.merge_status == 'success'
        run: |
          git push origin master
          echo "âœ… æ›´æ”¹å·²æŽ¨é€åˆ°è¿œç¨‹ä»“åº“" >> $GITHUB_STEP_SUMMARY
